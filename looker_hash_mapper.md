# Looker Hash Mapper ä½¿ç”¨èªªæ˜

## ç”¨é€”

å°‡ CMoney æä¾›çš„**é E.164 æ ¼å¼ hash** è½‰æ›ç‚º **E.164 æ ¼å¼é›»è©±è™Ÿç¢¼**ï¼Œé€é Looker åŒ¯å‡ºçš„ Member Personal Info è³‡æ–™é€²è¡Œ mappingã€‚

## å¿«é€Ÿé–‹å§‹

```bash
cd /Users/maki/91app
python3 looker_hash_mapper.py <lookeræª”æ¡ˆ.csv> <CMoneyç›®éŒ„> [è¼¸å‡ºå¾Œç¶´]
```

### ç¯„ä¾‹

```bash
# ä½¿ç”¨ 7M Looker è³‡æ–™ mapping CMoney æª”æ¡ˆ
python3 looker_hash_mapper.py looker_report_7000000.csv /Users/maki/Downloads/CMoney 7m

# ä½¿ç”¨æ–°ä¸‹è¼‰çš„å®Œæ•´è³‡æ–™
python3 looker_hash_mapper.py looker_full_20260115.csv /Users/maki/Downloads/CMoney full
```

## è¼¸å…¥æª”æ¡ˆæ ¼å¼

### Looker CSV æª”æ¡ˆ

å¿…é ˆåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼ˆç”± Looker UI åŒ¯å‡ºï¼‰ï¼š
- `Member Personal Info æ‰‹æ©Ÿè™Ÿç¢¼` - é E.164 hash
- `Member Personal Info æ‰‹æ©Ÿè™Ÿç¢¼(E.164)` - E.164 hash
- `Member Personal Info è¯çµ¡ Email` - Email hash
- `Member Personal Info è¯çµ¡ Email (raw data)` - Email raw data

**âš ï¸ é‡è¦æé†’ï¼šå¾ Looker UI ä¸‹è¼‰æ™‚å¿…é ˆå›ºå®šæ’åºæ¢ä»¶**
- å»ºè­°ä½¿ç”¨ä¸»éµæˆ–æ™‚é–“æ¬„ä½æ’åº
- é¿å…ã€Œä»Šå¤©è·Ÿæ˜å¤©ä¸‹è¼‰çµæœä¸ä¸€æ¨£ã€

### CMoney CSV æª”æ¡ˆ

- æ ¼å¼ï¼šæ¯è¡Œä¸€å€‹ hash å€¼
- ç·¨ç¢¼ï¼šUTF-8
- ä½ç½®ï¼šæŒ‡å®šçš„ CMoney ç›®éŒ„ä¸‹æ‰€æœ‰ `.csv` æª”æ¡ˆ

ç¯„ä¾‹ï¼š
```
00001c7d08db52fff2d4f0168d7c1d72674a52b1dad22fda728b95f17097f5b7
0000247a097250d7500b89bbaf7b9b2057e98356bbe30250de2f354d53d075d3
...
```

## è¼¸å‡º

### è¼¸å‡ºç›®éŒ„çµæ§‹

```
output/
â””â”€â”€ mapped_cmoney_{å¾Œç¶´}/
    â”œâ”€â”€ mapped_è† åŸ_480438.csv
    â”œâ”€â”€ mapped_é¢è†œ_704156.csv
    â””â”€â”€ mapped_é…µç´ _831756.csv
```

### è¼¸å‡ºæª”æ¡ˆæ ¼å¼

æ¯å€‹è¼¸å‡ºæª”æ¡ˆå°æ‡‰ä¸€å€‹è¼¸å…¥çš„ CMoney CSVï¼š
- **Matched (phone)**: è½‰æ›ç‚º E.164 æ ¼å¼çš„é›»è©±è™Ÿç¢¼ hash
- **Matched (email)**: è½‰æ›ç‚º raw email
- **Unmatched**: ä¿ç•™åŸå§‹ hashï¼ˆç„¡æ³• mappingï¼‰

### SQLite è³‡æ–™åº«

è…³æœ¬æœƒå»ºç«‹ï¼š`hash_mapping_{å¾Œç¶´}.db`

åŒ…å«å…©å€‹è¡¨ï¼š
- `phone_mapping`: phone_hash â†’ phone_e164
- `email_mapping`: email_hash â†’ email_raw

## è™•ç†æµç¨‹

```
1. å»ºç«‹ SQLite è³‡æ–™åº«
   â””â”€â”€ å»ºç«‹ phone_mapping å’Œ email_mapping è¡¨
   â””â”€â”€ å»ºç«‹ç´¢å¼•åŠ é€ŸæŸ¥è©¢

2. è¼‰å…¥ Looker è³‡æ–™
   â””â”€â”€ è®€å– Looker CSV
   â””â”€â”€ æ‰¹æ¬¡æ’å…¥è³‡æ–™åº«ï¼ˆ10,000 ç­†/æ‰¹æ¬¡ï¼‰
   â””â”€â”€ ä½¿ç”¨ INSERT OR REPLACE è™•ç†é‡è¤‡

3. è™•ç† CMoney æª”æ¡ˆ
   â””â”€â”€ æƒæ CMoney ç›®éŒ„ä¸‹æ‰€æœ‰ .csv
   â””â”€â”€ é€è¡ŒæŸ¥è©¢è³‡æ–™åº«
   â””â”€â”€ è¼¸å‡º mapped çµæœ

4. è¼¸å‡ºçµ±è¨ˆå ±å‘Š
   â””â”€â”€ å„æª”æ¡ˆ match rate
   â””â”€â”€ ç¸½é«” match rate
```

## æŠ€è¡“ç´°ç¯€

### ä¾è³´

**âœ… å®Œå…¨æœ¬åœ°åŒ–ï¼Œé›¶å¤–éƒ¨ä¾è³´**

ä½¿ç”¨çš„å¥—ä»¶ï¼ˆå…¨éƒ¨æ˜¯ Python æ¨™æº–åº«ï¼‰ï¼š
- `csv` - CSV æª”æ¡ˆè™•ç†
- `sqlite3` - SQLite è³‡æ–™åº«ï¼ˆPython å…§å»ºï¼‰
- `glob` - æª”æ¡ˆè·¯å¾‘åŒ¹é…
- `os` - ä½œæ¥­ç³»çµ±æ“ä½œ
- `sys` - ç³»çµ±åƒæ•¸
- `datetime` - æ™‚é–“è™•ç†

### æ•ˆèƒ½

- **æ‰¹æ¬¡è™•ç†**: 10,000 ç­†/æ‰¹æ¬¡ï¼Œæ¸›å°‘è³‡æ–™åº«å¯«å…¥æ¬¡æ•¸
- **ç´¢å¼•å„ªåŒ–**: phone_hash å’Œ email_hash éƒ½æœ‰ç´¢å¼•
- **è¨˜æ†¶é«”æ§åˆ¶**: ä¸²æµè®€å– CSVï¼Œä¸ä¸€æ¬¡è¼‰å…¥å…¨éƒ¨è³‡æ–™

### é æœŸè™•ç†æ™‚é–“

- è¼‰å…¥ 7M Looker è³‡æ–™ï¼š~60-90 ç§’
- Mapping 2M CMoney è¨˜éŒ„ï¼š~30-60 ç§’

## çµ±è¨ˆè¼¸å‡ºç¯„ä¾‹

```
============================================================
SUMMARY
============================================================
Total records processed: 2,041,186
Matched as phone (E.164): 392,677
Matched as email (raw data): 0
Unmatched (kept original): 1,648,509

ğŸ¯ Overall match rate: 19.24%

Output directory: output/mapped_cmoney_7m
```

## ç›¸é—œæª”æ¡ˆä½ç½®

### è³‡æ–™æª”æ¡ˆ
- Looker åŸå§‹è³‡æ–™ï¼š`/Users/maki/91app/looker_report_*.csv`
- CMoney åŸå§‹è³‡æ–™ï¼š`/Users/maki/Downloads/CMoney/*.csv`
- Mapping è¼¸å‡ºï¼š`/Users/maki/91app/output/mapped_cmoney_*/`

### æ–‡æª”
- æ“ä½œè¨˜éŒ„ï¼š`/Users/maki/91app/LOOKER_DATA_IMPORT_LOG.md`
- æœ¬æ–‡æª”ï¼š`/Users/maki/91app/looker_hash_mapper.md`

### è…³æœ¬
- Mapping å·¥å…·ï¼š`/Users/maki/91app/looker_hash_mapper.py`

## æ­·å²è³‡æ–™åƒè€ƒ

### å·²çŸ¥çš„ Match Rate

| Looker è³‡æ–™é‡ | Unique Hashes | Match Rate | æ—¥æœŸ |
|--------------|--------------|-----------|------|
| 7M | 3,648,581 phone + 3,573,022 email | 19.24% | 2026-01-15 |

### CMoney æª”æ¡ˆçµ±è¨ˆ

| æª”æ¡ˆ | è¨˜éŒ„æ•¸ | Matched (7M) | Match Rate |
|------|--------|-------------|-----------|
| è† åŸ_480438.csv | 486,154 | 93,985 | 19.33% |
| é¢è†œ_704156.csv | 712,988 | 137,972 | 19.35% |
| é…µç´ _831756.csv | 842,044 | 160,720 | 19.09% |

## å¸¸è¦‹å•é¡Œ

### Q1: ç‚ºä»€éº¼ match rate ä¸æ˜¯ 100%ï¼Ÿ

**åŸå› ï¼š**
1. CMoney çš„ hash å¯èƒ½ä¾†è‡ªä¸åŒæ™‚æœŸçš„è³‡æ–™
2. Looker è³‡æ–™åº«å¯èƒ½æ²’æœ‰åŒ…å«æ‰€æœ‰æœƒå“¡
3. éƒ¨åˆ†æ‰‹æ©Ÿè™Ÿç¢¼å¯èƒ½å·²è¢«åˆªé™¤æˆ–æ›´æ–°

### Q2: å¯ä»¥ç”¨ API è‡ªå‹•åŒ–å—ï¼Ÿ

**ä¸å»ºè­°ã€‚** åŸå› ï¼š
- Looker API offset-based pagination åœ¨åˆ†æå‹è³‡æ–™åº«ä¸Šä¸å¯é 
- åŸå› æ˜¯ non-deterministic orderingï¼ˆç„¡å›ºå®šæ’åºæ™‚çµæœé †åºä¸ç¢ºå®šï¼‰
- **æ¨è–¦æ–¹æ¡ˆï¼š** å¾ Looker UI æ‰‹å‹•ä¸‹è¼‰ï¼ˆä¸€æ¬¡æ€§/ä½é »æ›´æ–°ï¼‰

è©³è¦‹ï¼š`LOOKER_DATA_IMPORT_LOG.md`

### Q3: å¦‚ä½•ç¢ºä¿æ¯æ¬¡ä¸‹è¼‰è³‡æ–™ä¸€è‡´ï¼Ÿ

**é‡è¦ï¼š** åœ¨ Looker UI ä¸‹è¼‰æ™‚**å¿…é ˆå›ºå®šæ’åºæ¢ä»¶**
- ä½¿ç”¨ä¸»éµæˆ–æ™‚é–“æ¬„ä½æ’åº
- é¿å…ã€Œä»Šå¤©è·Ÿæ˜å¤©ä¸‹è¼‰çµæœä¸ä¸€æ¨£ã€

### Q4: SQLite è³‡æ–™åº«å¯ä»¥é‡è¤‡ä½¿ç”¨å—ï¼Ÿ

**å¯ä»¥ã€‚** å¦‚æœä½¿ç”¨ç›¸åŒçš„ Looker è³‡æ–™ï¼š
1. ä¿ç•™ `hash_mapping_{å¾Œç¶´}.db`
2. ç›´æ¥æŸ¥è©¢è³‡æ–™åº«é€²è¡Œ mapping
3. ä¸éœ€è¦é‡æ–°å»ºç«‹

ä½†å»ºè­°æ¯æ¬¡ä½¿ç”¨æ–° Looker è³‡æ–™æ™‚é‡æ–°å»ºç«‹è³‡æ–™åº«ã€‚

### Q5: å¦‚æœæœ‰æ–°çš„ CMoney æª”æ¡ˆè¦ mappingï¼Ÿ

```bash
# æ–¹æ¡ˆ 1: ä½¿ç”¨ç¾æœ‰è³‡æ–™åº«ï¼ˆå¦‚æœ Looker è³‡æ–™æœªæ›´æ–°ï¼‰
# ç›´æ¥æŠŠæ–°æª”æ¡ˆæ”¾åˆ° CMoney ç›®éŒ„ï¼Œé‡æ–°åŸ·è¡Œè…³æœ¬

# æ–¹æ¡ˆ 2: æ›´æ–° Looker è³‡æ–™å¾Œé‡æ–° mapping
python3 looker_hash_mapper.py <æ–°lookeræª”æ¡ˆ> /Users/maki/Downloads/CMoney new
```

## æœªä¾†æ”¹é€²æ–¹å‘

### å¦‚éœ€è¦è‡ªå‹•åŒ–

1. **ä½¿ç”¨ Looker Scheduled Delivery**
   - è¨­å®šæ’ç¨‹è‡ªå‹•åŒ¯å‡ºè³‡æ–™
   - è‡ªå‹•å‚³é€åˆ°æŒ‡å®šä½ç½®

2. **ä½¿ç”¨ Looker API + æ˜ç¢ºæ’åº**
   ```python
   # åœ¨ API æŸ¥è©¢ä¸­åŠ ä¸Š sorts åƒæ•¸
   params = {
       "limit": "7000000",
       "sorts": "member_id"  # æˆ–å…¶ä»–ä¸»éµæ¬„ä½
   }
   ```

3. **Cursor-based pagination**
   - å¦‚æœ Looker æ”¯æ´ï¼Œæ”¹ç”¨ cursor è€Œé offset

## éšæ®µæ€§æ–¹æ¡ˆèªªæ˜

**ç›®å‰ï¼ˆ2026-01-15ï¼‰ï¼š**
- âœ… è³‡æ–™ç”± Looker UI åŒ¯å‡º
- âœ… æ‰‹å‹•åŸ·è¡Œ mapping è…³æœ¬
- âœ… é©åˆä¸€æ¬¡æ€§æˆ–ä½é »æ›´æ–°

**æœªä¾†è€ƒé‡ï¼š**
- å¾…éœ€æ±‚ç©©å®šå†è©•ä¼°è‡ªå‹•åŒ–
- éœ€è¦é«˜é »æ›´æ–°æ™‚è€ƒæ…® Scheduled Delivery

---

**æœ€å¾Œæ›´æ–°ï¼š** 2026-01-15
**ç¶­è­·è€…ï¼š** Data Team
**ç›¸é—œæ–‡æª”ï¼š** LOOKER_DATA_IMPORT_LOG.md
