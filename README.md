# fan-out by storeId / shopId

æœ¬å°ˆæ¡ˆç”¨æ–¼è™•ç†å¤§é‡ CSV åŸå§‹è³‡æ–™ï¼Œä¾æ“šæŒ‡å®šçš„ä¸»éµæ¬„ä½ï¼ˆä¾‹å¦‚ `storeId` æˆ– `shopId`ï¼‰ï¼Œé€²è¡Œ **row-level fan-out**ï¼Œä¸¦å°‡è³‡æ–™å½™æ•´æˆä»¥ä¸»éµç‚ºå–®ä½çš„ç›®éŒ„çµæ§‹ï¼Œä¾›å¾ŒçºŒæµç¨‹ï¼ˆå¦‚ Google Apps Scriptã€Geminiã€ç°¡å ±è‡ªå‹•åŒ–ç­‰ï¼‰ä½¿ç”¨ã€‚

---

## ä½¿ç”¨æƒ…å¢ƒèªªæ˜

å…¸å‹æƒ…å¢ƒå¦‚ä¸‹ï¼š

- æœ‰å¤šå€‹ä¾†æº CSVï¼ˆä¾‹å¦‚ 60 å€‹ï¼‰ï¼Œæ¬„ä½çµæ§‹ä¸ä¸€è‡´
- æ¯å€‹ CSV ä¸­åŒ…å«å¤šç­†ä¸åŒ `storeId / shopId`
- éœ€è¦ï¼š
  - å…ˆä¾ä¸»éµæ‹†åˆ†è³‡æ–™åˆ—
  - å†å°‡åŒä¸€ä¸»éµçš„è³‡æ–™é›†ä¸­ç®¡ç†
  - ä¸¦èƒ½å¿«é€Ÿé©—è­‰æ‹†åˆ†çµæœæ˜¯å¦æ­£ç¢º

---

## å°ˆæ¡ˆçµæ§‹

```
.
â”œâ”€ fan_out_by_storeid.py     # ä¾ä¸»éµæ‹†åˆ† CSVï¼ˆrow-level fan-outï¼‰
â”œâ”€ verify_fanout.py          # é©—è­‰ fan-out çµæœå®Œæ•´æ€§èˆ‡æ­£ç¢ºæ€§
â”œâ”€ input/                    # åŸå§‹ CSV æ”¾ç½®ç›®éŒ„
â”‚   â”œâ”€ data_01.csv
â”‚   â”œâ”€ data_02.csv
â”‚   â””â”€ ...
â””â”€ output/                   # fan-out å¾Œè¼¸å‡ºç›®éŒ„
   â”œâ”€ store_001/
   â”‚  â”œâ”€ data_01.csv
   â”‚  â””â”€ data_03.csv
   â”œâ”€ store_002/
   â”‚  â””â”€ data_02.csv
   â””â”€ ...
```

---

## æ­¥é©Ÿä¸€ï¼šä¾ä¸»éµæ‹†åˆ† CSVï¼ˆfan-outï¼‰

åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œï¼š

```bash
python fan_out_by_storeid.py --input-dir ./input --output-dir ./output --encoding utf-8
```


### è¡Œç‚ºèªªæ˜

- é€æª”ã€é€åˆ—è®€å– `input/` åº•ä¸‹çš„ CSV
- å‹•æ…‹å°‹æ‰¾ä¸»éµæ¬„ä½ï¼ˆç›®å‰é è¨­ç‚º `storeId`ï¼Œå¯¦éš›å¯ä¾è³‡æ–™èª¿æ•´ï¼‰
- æ¯ä¸€åˆ—è³‡æ–™ä¾ä¸»éµå€¼è¼¸å‡ºåˆ°ï¼š

```
output/{storeId}/{åŸå§‹æª”å}.csv
```

- ä¸ä½¿ç”¨ pandas
- ä¸ä¿ç•™ file handleï¼ˆå³é–‹å³å¯«å³é—œï¼‰ï¼Œå¯å®‰å…¨è™•ç†å¤§é‡æª”æ¡ˆ

---

### ç‚ºä»€éº¼è¦æƒæ header rowï¼Œè€Œä¸æ˜¯å‡è¨­ç¬¬ä¸€åˆ—

æœ¬å°ˆæ¡ˆ**ä¸å‡è¨­ CSV çš„ç¬¬ä¸€åˆ—ä¸€å®šæ˜¯ header**ï¼Œè€Œæ˜¯æœƒé€åˆ—å¾€ä¸‹æƒæï¼Œæ‰¾åˆ°å¯¦éš›åŒ…å«ä¸»éµæ¬„ä½ï¼ˆä¾‹å¦‚ã€Œå•†åº—åºè™Ÿã€ï¼‰çš„é‚£ä¸€åˆ—ï¼Œæ‰è¦–ç‚ºçœŸæ­£çš„ headerã€‚

é€™æ˜¯å› ç‚ºå¯¦å‹™ä¸Šï¼Œè¨±å¤š CSV ä¾†æºä¸¦éã€Œç´”è³‡æ–™æª”ã€ï¼Œè€Œæ˜¯ç”± BI å·¥å…·æˆ–å ±è¡¨ç³»çµ±åŒ¯å‡ºï¼Œå¸¸è¦‹æœƒåœ¨æª”æ¡ˆæœ€å‰æ–¹åŠ å…¥ä¸€è‡³å¤šåˆ—çš„ **meta row**ï¼Œä¾‹å¦‚ï¼š

- å¹´ä»½ï¼æœŸé–“èªªæ˜ï¼ˆå¦‚ `Established At Year, 2025, 2024`ï¼‰
- ç¾¤çµ„æ¨™é¡Œã€å ±è¡¨è¨»è§£
- çµ¦äººé¡é–±è®€çš„èªªæ˜åˆ—ï¼Œè€Œéå¯¦éš›æ¬„ä½åç¨±

è‹¥å‡è¨­ç¬¬ä¸€åˆ—å³ç‚º headerï¼Œå°‡æœƒå°è‡´ï¼š
- ä¸»éµæ¬„ä½ç„¡æ³•è¢«æ­£ç¢ºè§£æ
- æ•´æ”¯æª”æ¡ˆè¢«èª¤åˆ¤ç‚ºæ ¼å¼éŒ¯èª¤è€Œè·³é
- fan-out èˆ‡é©—è­‰çµæœå‡ºç¾ã€Œçœ‹èµ·ä¾†ç¼ºè³‡æ–™ï¼Œä½†å¯¦éš›åŸå§‹æª”æœ‰è³‡æ–™ã€çš„å‡éŒ¯èª¤

å› æ­¤ï¼Œæœ¬å°ˆæ¡ˆæ¡ç”¨ **header æƒæç­–ç•¥**ï¼š
- å¾€ä¸‹å°‹æ‰¾ç¬¬ä¸€åˆ—åŒ…å«ä¸»éµæ¬„ä½åç¨±çš„åˆ—
- å°‡å…¶è¦–ç‚º header
- header ä¹‹å‰çš„åˆ—è¦–ç‚º meta rowï¼Œæ–¼ fan-out æ™‚åŸæ¨£ä¿ç•™è‡³è¼¸å‡ºæª”æ¡ˆä¸­

æ­¤è¨­è¨ˆå¯ç¢ºä¿ï¼š
- æ­£ç¢ºè™•ç†å¤šå±¤ header çš„å ±è¡¨å‹ CSV
- ä¿ç•™åŸå§‹å ±è¡¨èªæ„ï¼Œé¿å…ç ´å£ä¸‹æ¸¸ä½¿ç”¨æƒ…å¢ƒ
- fan-out èˆ‡ verify å° CSV çµæ§‹çš„ç†è§£ä¿æŒä¸€è‡´

- é€æª”ã€é€åˆ—è®€å– `input/` åº•ä¸‹çš„ CSV
- å‹•æ…‹å°‹æ‰¾ä¸»éµæ¬„ä½ï¼ˆç›®å‰é è¨­ç‚º `storeId`ï¼Œå¯¦éš›å¯ä¾è³‡æ–™èª¿æ•´ï¼‰
- æ¯ä¸€åˆ—è³‡æ–™ä¾ä¸»éµå€¼è¼¸å‡ºåˆ°ï¼š

```
output/{storeId}/{åŸå§‹æª”å}.csv
```

- ä¸ä½¿ç”¨ pandas
- ä¸ä¿ç•™ file handleï¼ˆå³é–‹å³å¯«å³é—œï¼‰ï¼Œå¯å®‰å…¨è™•ç†å¤§é‡æª”æ¡ˆ

---

## æ­¥é©ŸäºŒï¼šé©—è­‰ fan-out çµæœ

å®Œæˆæ‹†åˆ†å¾Œï¼Œå»ºè­°ç«‹å³åŸ·è¡Œé©—è­‰è…³æœ¬ï¼š

```bash
python verify_fanout.py --input-dir ./input --output-dir ./output --encoding utf-8
```

### é©—è­‰å…§å®¹åŒ…å«

1. **æª”åå®Œæ•´æ€§**
   - æª¢æŸ¥æ¯å€‹ store/shop ç›®éŒ„ä¸‹çš„ CSV æª”åæ˜¯å¦åˆç†
2. **è³‡æ–™æ­£ç¢ºæ€§**
   - é©—è­‰æ¯ä¸€åˆ—è³‡æ–™çš„ `storeId / shopId` æ˜¯å¦èˆ‡è³‡æ–™å¤¾åç¨±ä¸€è‡´
3. **å¿«é€Ÿå›é¥‹**
   - é©—è­‰é€Ÿåº¦å¿«ï¼Œå¯åœ¨å¤§é‡æª”æ¡ˆæƒ…å¢ƒä¸‹åè¦†åŸ·è¡Œ

è‹¥é©—è­‰å¤±æ•—ï¼Œç¨‹å¼æœƒå›å‚³é 0 çš„ exit codeï¼Œé©åˆæ¥å…¥è‡ªå‹•åŒ–æµç¨‹ã€‚

---

## æ­¥é©Ÿä¸‰ï¼šä¾å•†åº—åºè™Ÿç”¢ç”Ÿåˆ†æè¼¸å‡ºï¼ˆaggregate_by_store.pyï¼‰

æ­¤è…³æœ¬ç”¨æ–¼åœ¨ **fan-out å®Œæˆå¾Œ**ï¼Œé‡å°å–®ä¸€å•†åº—åºè™Ÿï¼Œç”¢ç”Ÿå¤šç¨®åˆ†æçµæœï¼ˆ23â€“25 ç³»åˆ—ï¼‰ï¼Œ
æ¯ä¸€å€‹åˆ†ææœƒè¼¸å‡ºç‚ºä¸€å€‹ç¨ç«‹çš„ CSVï¼Œä¸¦æ”¾ç½®æ–¼è©²å•†åº—åºè™Ÿç›®éŒ„åº•ä¸‹ã€‚

### æŒ‡ä»¤ç¯„ä¾‹

```bash
python aggregate_by_store.py --config 23-1
python aggregate_by_store.py --config 23-2
python aggregate_by_store.py --config 24-1
python aggregate_by_store.py --config 24-2
python aggregate_by_store.py --config 25-1
python aggregate_by_store.py --config 25-2
```

### è¼¸å‡ºçµæ§‹

```
output/
â””â”€ {å•†åº—åºè™Ÿ}/
   â”œâ”€ 23-1.csv
   â”œâ”€ 23-2.csv
   â”œâ”€ 24-1.csv
   â”œâ”€ 24-2.csv
   â”œâ”€ 25-1.csv
   â””â”€ 25-2.csv
```

> âš ï¸ ä¸¦éæ¯ä¸€å€‹å•†åº—éƒ½æœƒç”¢ç”Ÿå…¨éƒ¨åˆ†ææª”æ¡ˆã€‚  
> è‹¥è©²åˆ†ææ‰€éœ€çš„ã€Œå¿…è¦è³‡æ–™ä¸å­˜åœ¨ã€ï¼ˆä¾‹å¦‚é–€å¸‚å±¤ç´šè³‡æ–™ç¼ºå¤±ï¼‰ï¼Œ
> å‰‡è©²åˆ†æ **ä¸æœƒç”¢ç”Ÿè¼¸å‡ºæª”æ¡ˆ**ï¼Œä»¥é¿å…ç”¢ç”Ÿèª¤å°æ€§çµæœã€‚

### å„åˆ†æç°¡è¿°ï¼ˆèªæ„å±¤ï¼‰

- **23-1**ï¼šå¹´åº¦æ¨è–¦äººç¶å®š KPIï¼ˆç¸½é‡ã€YoYã€æ¨è–¦äººç¶å®šç‡ï¼‰
- **23-2**ï¼šæ¨è–¦äººç¶å®šæœˆåˆ¥ YoY è¶¨å‹¢
- **24-1**ï¼šæ¨è–¦äººç¸¾æ•ˆ KPIï¼ˆå¹´åº¦ï¼‰
- **24-2**ï¼šé–€å¸‚ Ã— æœˆä»½ æ¨è–¦äººè½‰æ›ç‡ï¼ˆé–€å¸‚å±¤ç´šï¼‰
- **25-1**ï¼šé–€å¸‚çµæ§‹åˆ†æï¼ˆæ¯å•†åº— Top 5 é–€å¸‚ï¼Œä¾ä½”æ¯” DESCï¼‰
- **25-2**ï¼šé–€å¸‚çµæ§‹åˆ†æï¼ˆæ¯å•†åº— Bottom 5 é–€å¸‚ï¼Œä¾ä½”æ¯” ASCï¼‰

```

---

## æ­¥é©Ÿå››ï¼šé©—è­‰æŒ‡å®šå•†åº—æ˜¯å¦å…·å‚™åˆ†ææ‰€éœ€è³‡æ–™ï¼ˆverify_store_presence.pyï¼‰

æ­¤è…³æœ¬ç”¨æ–¼ **å¿«é€Ÿæª¢æŸ¥æŒ‡å®šå•†åº—åºè™Ÿ**ï¼Œåœ¨å…­å€‹æ ¸å¿ƒè³‡æ–™ä¾†æºä¸­æ˜¯å¦å­˜åœ¨è³‡æ–™åˆ—ï¼Œ
ä»¥è§£é‡‹ã€Œç‚ºä½•æŸäº›åˆ†ææª”æ¡ˆæœªç”¢ç”Ÿã€ã€‚

### ä½¿ç”¨æ™‚æ©Ÿ

- æŸå•†åº—åªç”¢ç”Ÿéƒ¨åˆ†åˆ†ææª”æ¡ˆ
- æƒ³ç¢ºèªæ˜¯è³‡æ–™ç¼ºå¤±ï¼Œé‚„æ˜¯ç¨‹å¼éŒ¯èª¤
- ä½œç‚ºåˆ†æå‰çš„è³‡æ–™å¯ç”¨æ€§æª¢æŸ¥ï¼ˆpre-checkï¼‰

### æŒ‡ä»¤ç¯„ä¾‹

```bash
python verify_store_presence.py --store 1194
python verify_store_presence.py --store 40316
```

### è¼¸å‡ºèªªæ˜ï¼ˆç¯„ä¾‹ï¼‰

```text
ğŸ” æª¢æŸ¥å•†åº—åºè™Ÿï¼š40316

âœ… å€é–“æ¨è–¦äººç¶å®šè³‡æ–™ï¼šæœ‰è³‡æ–™
â›” é–€å¸‚é¦–è³¼äººæ•¸ï¼ˆæœˆåˆ¥ï¼‰ï¼šæ²’æœ‰è³‡æ–™
â›” é–€å¸‚é¦–è³¼äººæ•¸ï¼ˆé–€å¸‚ï¼‰ï¼šæ²’æœ‰è³‡æ–™
```

### è§£è®€åŸå‰‡

- **23 / 24 ç³»åˆ—**ï¼šåªè¦å•†åº—å±¤ç´šè³‡æ–™å­˜åœ¨ï¼Œå³å¯ç”¢ç”Ÿ
- **24-2 / 25 ç³»åˆ—**ï¼šéœ€è¦é–€å¸‚å±¤ç´šè³‡æ–™ï¼Œè‹¥ç¼ºå¤±å‰‡ä¸ç”¢ç”Ÿè¼¸å‡º

æ­¤è…³æœ¬æœ¬èº«ä¸åšä»»ä½•åˆ†ææˆ–è¨ˆç®—ï¼Œåƒ…è² è²¬å›ç­”ï¼š

>ã€Œé€™å€‹å•†åº—ï¼Œèƒ½ä¸èƒ½åšå“ªäº›åˆ†æï¼Ÿã€

```

---

## æ³¨æ„äº‹é …

- ç›®å‰ä¸»éµæ¬„ä½åç¨±ä»¥ `storeId` ç‚ºé è¨­ï¼Œå¯¦éš›ä½¿ç”¨æ™‚è«‹ä¾çœŸå¯¦è³‡æ–™èª¿æ•´
- CSV æª”åå¯ç‚ºä¸­æ–‡ï¼ŒPython 3 / macOS ç’°å¢ƒå¯æ­£å¸¸è™•ç†
- æœ¬å°ˆæ¡ˆåƒ…è² è²¬ **è³‡æ–™æ‹†åˆ†èˆ‡é©—è­‰**
  - å¾ŒçºŒ Google Drive æ¬ç§»ã€Apps Scriptã€Gemini è™•ç†ä¸åœ¨æ­¤å°ˆæ¡ˆç¯„åœå…§

---

## å¾ŒçºŒæµç¨‹ï¼ˆä¸åœ¨æœ¬å°ˆæ¡ˆå…§ï¼‰

- ä¾ Google Sheets å°ç…§è¡¨ï¼ˆshopId â†’ Drive folderï¼‰
- ä½¿ç”¨ Google Apps Script æ¬ç§» fan-out å¾Œçš„è³‡æ–™å¤¾
- äº¤ç”± Gemini ç”¢ç”Ÿç°¡å ±æˆ–æ–‡å­—å…§å®¹

æœ¬å°ˆæ¡ˆå®šä½ç‚º **è³‡æ–™å‰è™•ç†èˆ‡ç©©å®šæ€§é©—è­‰å±¤**ã€‚

```
python3 -m venv .venv
source .venv/bin/activate
pip install pandas
```

```
source .venv/bin/activate
python aggregate_by_store.py --config 23-1
python aggregate_by_store.py --config 23-2
python aggregate_by_store.py --config 24-1
python aggregate_by_store.py --config 24-2
python aggregate_by_store.py --config 25-1
python aggregate_by_store.py --config 25-2
```